{"ast":null,"code":"let _id = 0;\n\nclass WebGLShaderCache {\n  constructor() {\n    this.shaderCache = new Map();\n    this.materialCache = new Map();\n  }\n\n  update(material) {\n    const vertexShader = material.vertexShader;\n    const fragmentShader = material.fragmentShader;\n\n    const vertexShaderStage = this._getShaderStage(vertexShader);\n\n    const fragmentShaderStage = this._getShaderStage(fragmentShader);\n\n    const materialShaders = this._getShaderCacheForMaterial(material);\n\n    if (materialShaders.has(vertexShaderStage) === false) {\n      materialShaders.add(vertexShaderStage);\n      vertexShaderStage.usedTimes++;\n    }\n\n    if (materialShaders.has(fragmentShaderStage) === false) {\n      materialShaders.add(fragmentShaderStage);\n      fragmentShaderStage.usedTimes++;\n    }\n\n    return this;\n  }\n\n  remove(material) {\n    const materialShaders = this.materialCache.get(material);\n\n    for (const shaderStage of materialShaders) {\n      shaderStage.usedTimes--;\n      if (shaderStage.usedTimes === 0) this.shaderCache.delete(shaderStage);\n    }\n\n    this.materialCache.delete(material);\n    return this;\n  }\n\n  getVertexShaderID(material) {\n    return this._getShaderStage(material.vertexShader).id;\n  }\n\n  getFragmentShaderID(material) {\n    return this._getShaderStage(material.fragmentShader).id;\n  }\n\n  dispose() {\n    this.shaderCache.clear();\n    this.materialCache.clear();\n  }\n\n  _getShaderCacheForMaterial(material) {\n    const cache = this.materialCache;\n\n    if (cache.has(material) === false) {\n      cache.set(material, new Set());\n    }\n\n    return cache.get(material);\n  }\n\n  _getShaderStage(code) {\n    const cache = this.shaderCache;\n\n    if (cache.has(code) === false) {\n      const stage = new WebGLShaderStage();\n      cache.set(code, stage);\n    }\n\n    return cache.get(code);\n  }\n\n}\n\nclass WebGLShaderStage {\n  constructor() {\n    this.id = _id++;\n    this.usedTimes = 0;\n  }\n\n}\n\nexport { WebGLShaderCache };","map":null,"metadata":{},"sourceType":"module"}